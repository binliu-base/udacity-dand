Exploratory Analysis of Prosper.com Loans
========================================================
#### Bin Liu
#### Udacity Data Analyst Nanodegree Project 4


```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages that you end up using
# in your analysis in this code chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk.
# This prevents the code from displaying in the knitted HTML output.
# You should set echo=FALSE for all code chunks in your file.
library(dplyr)
library(ggplot2)
library(GGally)
library(tidyr)
library(plotly)
library(lubridate)
library(gridExtra)
# separate, unite
# opts_chunk
library(knitr)
setwd("D:/udacity/dand/p4-local/work/dand-170822/p4")
```

```{r cache=TRUE, LoadData}
# Load the Data
full.df <- read.csv("prosperLoanData.csv",sep=",")

# convert to date class and drop empty time notation using lubridate
x <- as.character(full.df$ LoanOriginationDate)
full.df$LoanOriginationDate <- ymd_hms(x)
x <- as.character(full.df$ ListingCreationDate)
full.df$ListingCreationDate <- ymd_hms(x)

# convert LoanOriginationQuarter to have the year first using tidyr pkg
full.df$ LoanOriginationQuarter <- as.character(full.df$ LoanOriginationQuarter)
full.df <- full.df %>% 
          separate(col = LoanOriginationQuarter, 
                   into = c("Quarters", "Year"), sep = " ") %>%
          unite(col = LoanOriginationQuarter, Year, Quarters, sep = " ")

# Rename variables that were made with parentheses
full.df <- full.df %>% rename(ListingCategory = ListingCategory..numeric., 
                            ProsperRating = ProsperRating..numeric.,
                            ProsperRatingCategory = ProsperRating..Alpha.)
# Add factors to LoanType
x <- c("Not Applicable", "Debt Consolidation", "Home Improvement",
       "Business", "Personal Loan", "Student Use", "Auto", "Other",
       "Baby&Adoption", "Boat", "Cosmetic Procedure", "Engagement Ring", 
       "Green Loans", "Household Expenses", "Large Purchases",
       "Medical/Dental", "Motorcycle", "RV", "Taxes", "Vacation", 
       "Wedding Loans")
full.df$ ListingCategory <- factor(full.df$ ListingCategory, 
                                 levels = seq(0:20), labels = x)
# Average credit score range into single value
full.df <- full.df %>% 
          mutate(CreditScore = CreditScoreRangeLower * 0.5 + 
                               CreditScoreRangeUpper * 0.5)


```

# Univariate Plots Section

The first thing I analyzed was the financial stability of Prosper business. How their business was growing and were there any ups and downs between 2005 and 2014. Let’s see how are loans distributed over the years.


# ```{r echo=FALSE, message=FALSE , warning=FALSE}
```{r}
# 1.  aggregate dollar originations July 2009 - Dec 2013
# modeled on pg 74 of 2013 annual report
originationdf <- full.df %>% 
               select(Quarter = LoanOriginationQuarter,
                      Amount = LoanOriginalAmount) %>%
               group_by(Quarter) %>%
               summarise(Loans = n()/ 10 ^ 3, 
                         Dollars = sum(Amount)/ 10 ^ 6) %>%
               arrange(Quarter) %>%
               filter(Quarter < "2014")

ggOriginationDollars <- ggplot(originationdf, aes(x = Quarter, y = Dollars)) +
    geom_bar(stat = "identity", fill = "green4") +
    geom_text(aes(label = round(Dollars, 0)), vjust = -0.5, size = 4) +
    theme(axis.text.x = element_text(angle = -90, vjust = 0.5),
          axis.title.x = element_blank()) +
    ylab("Dollar Originations (millions)") +
    ggtitle("Quarterly Dollar Originations through FY 2013")
ggOriginationDollars
```
The chart in the annual report began in the third quarter of 2009. The period of October 15, 2008 to July 13, 2009 is known as Prosper’s Quiet Period (http://www.lendacademy.com/a-look-back-at-the-lending-club-andprosper-quiet-periods/) when they were required to suspend lending pending SEC approval. When they relaunched in July 2009, there were several changes to their lending process, so I’ll have to keep that in mind.

```{r}
#2.  plot of number of loan originations v time
ggOriginations <- ggplot(originationdf, aes(x = Quarter, y = Loans)) +
#    geom_bar(stat = "identity", fill = "orchid4") +
    geom_bar(stat = "identity", fill = "blue4") +  
    theme(axis.text.x = element_text(angle = -90, vjust = 0.5),
          axis.title.x = element_blank()) +
    ylab("Originations (Thousands)") +
    ggtitle("Quarterly Number of Loan Originations through FY 2013")
ggOriginations
```

```{r}
summary(full.df$ LoanStatus)
#3.  create a new variable summarizing the result of each loan
full.df <- full.df %>% mutate(Results = ifelse(LoanStatus %in% 
                     c("Cancelled", "Chargedoff", "Defaulted"), 0,
                     ifelse(LoanStatus %in% 
                     c("Completed", "Current", "FinalPaymentInProgress"), 2, 
                     1)))
full.df$ Results <- factor(full.df$ Results, levels = 0:2, 
                         labels = c("Defaulted", "Past Due", "Current or Paid"))

defaultsdf <- full.df %>% group_by(Quarter = LoanOriginationQuarter, Results) %>%
            summarize(Loans = n() / 10 ^ 3) %>% 
            arrange(Quarter, Results) %>%
            filter(Quarter < "2014")

ggDefaults <- ggplot(defaultsdf, aes(x = Quarter, y = Loans, fill = Results)) +
    geom_bar(stat = "identity") +
    theme(axis.text.x = element_text(angle = -90, vjust = 0.5),
          axis.title.x = element_blank()) +
    ylab("Originations (Thousands)") +
    ggtitle("Results of Loans Originated through FY 2013")
ggDefaults
```


**What is the most frequent Term of loan?**
```{r}
## 4.  Most common term loan
term.df <- full.df
term.df$Term<-factor(term.df$ Term)
ggplot(data=term.df,aes(Term)) + 
  geom_bar(color=I('black'),fill=I('blue4'),stat = "count", width = 0.3) + 
 
  ggtitle("The length of the loan in months")
```

```{r}
## 5.  
defaultersdf <- full.df %>% group_by(ProsperRatingCategory, Results) %>%
                summarize(Loans = n() / 10 ^ 3) %>%
                arrange(ProsperRatingCategory)

defaultersdf$ProsperRatingCategory <- ordered(defaultersdf$ProsperRatingCategory, levels = c("AA",
                     "A", "B", "C", "D","E","HR","N/A"))

ggWhoDefaults <- ggplot(defaultersdf, aes(x = ProsperRatingCategory, y = Loans,
                                          fill = Results)) +
                 geom_bar(stat = "identity") + 
                 ylab("Loans (Thousands)")
ggWhoDefaults
```

**Why people use Prosper?**
```{r}
## 5.
qplot(ListingCategory, data = full.df) + 
    theme(axis.text.x = element_text(angle = -90))
```

**What's the borrower's credit score?**

```{r  warning=FALSE}
## 6.
x <- qplot(CreditScore, data = full.df, xlim = c(300, 850))
suppressMessages(print(x))
```

Credit scores range from 300 to 850.  Prosper borrower have a median score of `r median(full.df$CreditScore)`, which is considered good credit.  Prosper now requires a minimum credit score of 640 for new borrowers or 600 for returning borrowers, but initially, subprime borrowers could also apply for loans.


**How much people are borrowing?**

```{r echo=FALSE, "How much people are borrowing"}
## 7.
ggplot(aes(x = LoanOriginalAmount), data = full.df) + 
  geom_histogram(binwidth=500, color='black') +
  ggtitle("Histogram of Loan Original Amount") +
  xlab("Loan Original Amount")

summary(full.df$LoanOriginalAmount)
```

**How much borrowers earn annually?**

```{r}
## 8.
full.df$IncomeRange <- ordered(full.df$IncomeRange, levels = c("Not displayed",
                     "Not employed", "$0", "$1-24,999", "$25,000-49,999", 
                      "$50,000-74,999", "$75,000-99,999", "$100,000+"))

qplot(IncomeRange, data = full.df) + 
    theme(axis.text.x = element_text(angle = -90))
```
**What's the distribution of Monthly Loan Payment**

```{r echo=FALSE}
## 9.
ggplot(aes(x = MonthlyLoanPayment), data = full.df) + 
  geom_histogram(fill = "#ABADA6", color='black', binwidth = 10) +
  ggtitle("Histogram of Monthly Loan Payment") +
  xlab("Monthly Loan Payment")

summary(full.df$MonthlyLoanPayment)

## 10.
ggplot(aes(x = sqrt(MonthlyLoanPayment)), data = full.df) + 
  geom_histogram(fill = "#ABADA6", color='black', binwidth = 1) +
  ggtitle("Histogram of (sqrt) Monthly Loan Payment") +
  xlab("sqrt(Monthly Loan Payment)")
```

**How the Debt to Income is distributed?**

```{r echo=FALSE, "How the Debt to Income is distributed"}
## 11.
ggplot(aes(x = DebtToIncomeRatio), 
       data = subset(full.df, DebtToIncomeRatio < 1)) + 
  geom_histogram(fill = "#ABADA6", color='black', binwidth = 0.01) +
  ggtitle("Histogram of Debt To Income Ratio") +
  xlab("Debt To Income Ratio")

summary(full.df$DebtToIncomeRatio)
```

**How lenders benefit from investing in loans?**

```{r echo=FALSE, "The Lender Yield on the Loan"}
summary(full.df$LenderYield)

## 12.
ggplot(aes(x=LenderYield), data=full.df) + 
    geom_histogram(binwidth=0.005, fill = "#ABADA6", color='black') +
    scale_x_continuous(breaks=seq(0, 0.5, 0.05)) + 
    labs(title="The Lender Yield on the Loan") +
    xlab("Lender Yield")
```


# Univariate Analysis

### What is the structure of your dataset?
    
The ProsperLoan dataset contains `r nrow(full.df)` loans and 81 variables. The loans cover the period `r range(full.df$LoanOriginationDate)`.  Variables are of classes int, numeric, date, and factor.

### What is/are the main feature(s) of interest in your dataset?
There are two domain in the ProsperLoan model. Domain one is company domain (one role: Prosper), Domain two is customer domain (tow role: Investor and borrower).

As a business, Prosper would be most concerned with LP_ServiceFees and LP_CollectionFees, which form their primary revenue source.

The main feature of the borrowers is ProsperRating, which is based on their credit score and history with Prosper loans.

For investors, the main features are the LenderYield (interest rate minus the service fee) and the LP_NetPrincipalLoss, which is the principal that remains uncollected after any recoveries.


### What other features in the dataset do you think will help support your investigation into your feature(s) of interest?

Other variables that can help me to support my investigation are Debt To Income Ratio, Occupation, Employment Status and 
Employment Duration.


### Did you create any new variables from existing variables in the dataset?
I created two new variables, The first is CreditScore, which is average number of the CreditScoreRangeUpper and CreditScoreRangeLower variables.  Another is a factor variable Results, which simplify each loans status as "Current or Paid", "Past Due", or "Defaulted". 

### Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?

There is a high decrease of the number of the loans between the fourth quarter of 2008 and 
The fourth quarter of 2009. Cause is  Prosper's business model came under scrutiny by the US Securities and Exchange Commission at that time. If I was not aware of the event, this would be a unusual distributions.


# Bivariate Plots Section
```{r echo=FALSE, message=FALSE , warning=FALSE}
full.df <- full.df %>% 
          mutate(Rating = ordered(x = ifelse(!is.na(ProsperRating), 
                                                    ProsperRating, 0), 
                                  levels = 0:7, 
                          # labels = c("N/A", "HR", "E", "D", "C", "B", "A", "AA")))
                          labels = c("AA", "A", "B", "C", "D", "E", "HR", "N/A")))
## 13.
# boxplot(CreditScore ~ Rating, data = full.df, ylim = c(600, 850))

p <- ggplot(data = full.df, aes(x = ProsperRatingCategory, y = CreditScore)) +
        geom_boxplot() +
        ylim(600, 850) +
        xlab("Prosper Rating") +
        ylab("Credit Score")

p + labs(title = "Borrower's Credit Score by Prosper Rating")
# p + labs(x = "Prosper Rating")
# p + labs(y = "Credit Score")
```

```{r echo=FALSE, message=FALSE , warning=FALSE}
## 14.
# boxplot(BorrowerAPR ~ Rating, data = full.df) 

full.df$ProsperRatingCategory <- ordered(full.df$ProsperRatingCategory, levels = c("AA",
                     "A", "B", "C", "D","E","HR","N/A"))

p <-ggplot(data = full.df, aes(x = ProsperRatingCategory, y = BorrowerAPR)) +
        geom_boxplot() +
        xlab("Prosper Rating")


p + labs(title = "Borrower's Annual Percentage Rate (APR) by Prosper Rating")

```


```{r}
full.df$ProsperRating <- ordered(full.df$ProsperRating,
                        labels = rev(c("HR", "E", "D", "C", "B", "A", "AA")))
ratinglevels <- rev(c("HR", "E", "D", "C", "B", "A", "AA"))
full.df <- full.df %>%
          mutate(Rating = ifelse(ProsperRating %in% ratinglevels,
                                 as.character(ProsperRating),
                                 ifelse(CreditGrade %in% ratinglevels,
                                        as.character(CreditGrade),
                                        NA)))
full.df$Rating <- ordered(full.df$Rating, labels = ratinglevels)
catdefaultsdf <- full.df %>%
                 group_by(Quarter = LoanOriginationQuarter, Rating, Results) %>%
                 summarize(Loans = n())
# 
# ggCatdefaults <- ggplot(data = subset(catdefaultsdf, as.numeric(Results) < 2), 
#                         aes(x = Quarter, y = Loans, 
#                             color = Rating, group = Rating)) +
#                  geom_line() +
#                  scale_colour_brewer(palette = "Reds") +
#                  theme(axis.text.x = element_text(angle = -90, vjust = 0.5)) +
#                  xlab("Loan Origination") +
#                  ggtitle("Defaults for Loans Originated through FY 2013")
# ggCatdefaults
```

```{r}
## 15.
catRateDefaultsdf <- full.df %>% 
                 group_by(Quarter = LoanOriginationQuarter, Rating, Results) %>%
                 summarize(TotalperRating = n()) %>%
                 mutate(Rate = TotalperRating / sum(TotalperRating)) 
                 

ggCatRateDefaults <- ggplot(data = subset(catRateDefaultsdf, 
                                          as.numeric(Results) < 2), 
                        aes(x = Quarter, y = Rate * 100, 
                            color = Rating, group = Rating)) +
                 geom_line() +
                 theme(axis.text.x = element_text(angle = -90, vjust = 0.5)) +
                 xlab("Loan Origination") +
                 ylab("Rate (percentage)") +
                 ggtitle("Default Rate by Loans Originated through FY 2013")
ggCatRateDefaults
```

```{r}
# 16.

ggLossCat <- ggplot(data = arrange(full.df, Results), 
                 aes(x = Rating, 
                     y = LP_GrossPrincipalLoss / LoanOriginalAmount)) +
             geom_bar(stat = "summary", fun.y = mean)
ggLossCat
```

The average loss rate per dollar invested

```{r}

# 17.
ggLossCatTime <- ggplot(data = arrange(full.df, Results), 
                 aes(x = LoanOriginationQuarter, 
                     y = LP_GrossPrincipalLoss / LoanOriginalAmount)) +
                 geom_bar(stat = "summary", fun.y = mean) +
                 theme(axis.text.x = element_blank()) +
                 facet_wrap(~Rating)
ggLossCatTime
```

```{r}
start_date <- ymd("2009-07-15")
loans <- full.df %>% 
         mutate(InvestorProfit = LP_CustomerPayments - LoanOriginalAmount -
                                 LP_ServiceFees - LP_CollectionFees + 
                                 LP_NonPrincipalRecoverypayments,
                InvestorProfitRate = InvestorProfit / LoanOriginalAmount
                ) %>% 
         filter(LoanStatus %in% c("Completed", "Chargedoff", "Defaulted",
                                  "FinalPaymentInProgress")) %>% 
         filter(LoanOriginationDate >= start_date) %>% 
         filter(Rating != "") %>% 
         select(Results, InvestorProfit, InvestorProfitRate, Rating,
                LoanOriginationDate, LoanOriginationQuarter,
                LoanOriginalAmount, BorrowerAPR, Term, ListingCategory,
                CreditScore, RevolvingCreditBalance, 
                AvailableBankcardCredit, StatedMonthlyIncome) %>% 
         droplevels()
print("Dimensions of new dataset")
dim(loans)
print("Loan results by rating")
table(loans$Results, loans$Rating)

```

```{r}
# 18.
ggplot(loans, aes(LoanOriginationDate, InvestorProfit)) +  
    geom_point(aes(color = Results), alpha = 0.05) + 
    geom_smooth(stat = 'summary', fun.y = mean)
```

```{r}
loans2 <- loans %>% 
          filter((LoanOriginationDate < ymd("2013-03-11") & Term <= 12) |
                 (LoanOriginationDate < ymd("2011-03-11") & Term <= 36)) %>%           
          droplevels()
dim(loans2)
```


```{r}
# 19.
x <- ggplot(loans2, aes(LoanOriginationDate, InvestorProfitRate)) +  
     geom_point(aes(color = factor(Term)), alpha = 0.3) + 
     geom_smooth()
suppressMessages(print(x))
```

```{r}
# 20.
loans2 <- loans2 %>% 
          filter(Term == 36) %>%
          select(-Term)
dim(loans2)
ggplot(loans2, aes(LoanOriginationDate, InvestorProfitRate)) +  
    geom_point(alpha = 0.3) + 
    geom_smooth(method = lm)
```

# Bivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?

### Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?

### What was the strongest relationship you found?




# Multivariate Plots Section

```{r echo=FALSE, Multivariate_Plots}

```

# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?

### Were there any interesting or surprising interactions between features?

### OPTIONAL: Did you create any models with your dataset? Discuss the strengths and limitations of your model.

------

# Final Plots and Summary

### Plot One
```{r echo=FALSE, Plot_One}

```

### Description One


### Plot Two
```{r echo=FALSE, Plot_Two}

```

### Description Two


### Plot Three
```{r echo=FALSE, Plot_Three}

```

### Description Three

------

# Reflection
